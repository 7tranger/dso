# ADR-001: Валидация входных загрузок (файлы)

## Status
Accepted

## Context
Сервис принимает пользовательские файлы. Риски включают попытки path traversal, загрузку чрезмерно больших файлов, несоответствие MIME и содержимого (magic bytes), а также запись в небезопасные пути (симлинки).

## Decision
- Вводим эндпойнт `/upload` с жёсткой валидацией:
  - Лимит размера файла: 1MB (жёстко, конфигурируемо в будущем).
  - Разрешённые типы: `image/png`, `image/jpeg`.
  - Проверка magic bytes: PNG (\x89PNG\r\n\x1a\n), JPEG (префикс \xFF\xD8\xFF).
  - Генерация целевого имени: UUID v4 (hex) + расширение по MIME; пользовательское имя игнорируется.
  - Канонизация путей: запись только в каталог `uploads/` в корне приложения.
  - Запрет симлинков: каталог `uploads/` не должен быть симлинком; запись в симлинк-файлы запрещена.

## Consequences
- Снижается риск DoS по памяти/диску, path traversal и обхода MIME через неверные заголовки.
- Требуются негативные тесты для граничных сценариев и обновление документации.

## Links
- NFR: `NFR-008` (Валидация входных данных)
- P04: `F#-Upload-File`, `R#-Upload-Validation` (идентификаторы требований курса)
- Tests: `tests/test_uploads.py::test_upload_rejects_large_file`, `tests/test_uploads.py::test_upload_rejects_wrong_signature`, `tests/test_uploads.py::test_upload_png_ok_and_uuid_name`
- RISKS: Закрывает меры по `R006` (Манипуляция с валидацией). Критерий закрытия: тесты негативных сценариев проходят; ручная попытка traversal не использует пользовательское имя файла, запись идёт в UUID в `uploads/`.
